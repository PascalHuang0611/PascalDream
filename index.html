<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•æˆ°é¬¥éŠæˆ²</title>
    <style>
        /* --- æ•´é«”é é¢æ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: flex-start; /* æ”¹ç‚ºå·¦å°é½Šä»¥ä¿®å¾©æ»¾è»¸å•é¡Œ */
            align-items: flex-start; /* é ‚éƒ¨å°é½Š */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: auto; /* ç•¶å…§å®¹è¶…å‡ºè¢å¹•å¯¬åº¦æ™‚ï¼Œé¡¯ç¤ºæ°´å¹³æ»¾è»¸ */
        }

        /* --- ä¸»æ‡‰ç”¨ç¨‹å¼åŒ…è£¹å®¹å™¨ --- */
        #app-wrapper {
            display: flex;
            flex-direction: row; /* å§‹çµ‚ä¿æŒæ°´å¹³æ’åˆ— */
            align-items: flex-start;
            gap: 20px;
        }

        /* --- ä¿®ç…‰é¢æ¿ --- */
        #cultivation-panel {
            width: 300px;
            height: 700px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
            gap: 15px; /* ç¨å¾®èª¿æ•´é–“è· */
            flex-shrink: 0;
        }
        #cultivation-panel h2 {
            margin: 0;
            color: #00bcd4;
            text-align: center;
        }

        /* å¤©æ°£è³‡è¨Š */
        #weather-info {
            width: 100%;
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 14px;
        }
        #weather-info p {
            margin: 4px 0;
        }
        #weather-location {
            font-weight: bold;
            font-size: 16px;
        }

        .meditation-visual {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .meditation-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .meditating-person-img {
            width: 150px;
            height: 150px;
            object-fit: contain; /* é¿å…åœ–ç‰‡è¢«æ‹‰ä¼¸ */
        }
        
        .revolving-orb {
            position: absolute;
            top: 50%; /* å°‡å‹•ç•«ä¸­å¿ƒé»è¨­åœ¨å®¹å™¨ä¸­å¤® */
            left: 50%;
            width: 20px;
            height: 20px;
            background-color: #00e5ff;
            border-radius: 50%;
            box-shadow: 0 0 10px #00e5ff, 0 0 20px #00e5ff, 0 0 30px #fff;
            animation: revolve 10s linear infinite;
        }

        @keyframes revolve {
            from {
                transform: translate(-50%, -50%) rotate(0deg) translateX(100px) rotate(0deg);
            }
            to {
                transform: translate(-50%, -50%) rotate(360deg) translateX(100px) rotate(-360deg);
            }
        }

        .cultivation-stats {
            width: 100%;
            text-align: center;
            font-size: 18px; /* èª¿æ•´å­—é«”å¤§å°ä»¥å®¹ç´æ–°è¡Œ */
        }
         .cultivation-stats p {
            margin: 8px 0;
        }
        
        /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
        #game-container {
            width: 850px; /* å›ºå®šå¯¬åº¦ä»¥ç¶­æŒç‰ˆé¢ */
            height: 700px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            gap: 15px;
            flex-shrink: 0; /* é˜²æ­¢å®¹å™¨è¢«å£“ç¸® */
        }

        /* æˆ°é¬¥ç•«é¢å®¹å™¨ */
        #combat-screen {
            flex-grow: 1;
            position: relative;
            min-height: 250px;
            background-color: #333; 
            border: 1px solid #4f4f4f; 
            border-radius: 10px;      
        }

        /* --- æ¸¬è©¦æ§åˆ¶é … --- */
        #test-controls {
            padding: 15px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 200px;
            flex-shrink: 0; /* é˜²æ­¢æ­¤å®¹å™¨ä¹Ÿè¢«å£“ç¸® */
        }
        #test-controls label {
            font-weight: bold;
            color: #ffa500;
        }
        #test-controls select {
            padding: 8px;
            background-color: #3c3c3c;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }


        /* ç•«é¢éœ‡å‹•æ”»æ“Šç‰¹æ•ˆ */
        .screen-shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- è§’è‰²å¡ç‰‡é€šç”¨æ¨£å¼ --- */
        .character-card {
            width: 200px;
            padding: 15px;
            background-color: #3c3c3c;
            border: 1px solid #555;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: absolute; 
            transition: transform 0.2s ease;
        }

        .character-card h2 {
            margin-top: 0;
            color: #ffa500;
        }

        .character-card.attacking {
            transform: scale(1.1);
        }

        #player { bottom: 20px; left: 20px; }
        #monster { top: 20px; right: 20px; }

        /* --- è¡€æ¢/è¡Œå‹•æ¢æ¨£å¼ --- */
        .bar-container {
            width: 100%;
            height: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #555;
            margin-top: 5px;
        }
        .bar { height: 100%; border-radius: 8px; transition: width 0.1s linear; }
        #player-health-bar { background-color: #4caf50; }
        #monster-health-bar { background-color: #f44336; }
        #player-action-bar { background-color: #00bcd4; }
        #monster-action-bar { background-color: #ff9800; }
        .hp-text { font-size: 14px; text-align: center; margin-top: 5px; font-weight: bold; }

        /* --- æˆ°é¬¥æ—¥èªŒèˆ‡æ§åˆ¶ --- */
        #controls { display: flex; flex-direction: column; align-items: center; gap: 15px; flex-shrink: 0; }
        #combat-log { width: 100%; height: 140px; background-color: rgba(0,0,0,0.3); border: 1px solid #555; padding: 10px; overflow-y: auto; border-radius: 8px; font-family: monospace; font-size: 14px; box-sizing: border-box; flex-shrink: 0; }
        #combat-log p { margin: 0 0 5px 0; padding: 0; color: #ddd; }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button { padding: 12px 25px; font-size: 18px; font-weight: bold; color: white; background: linear-gradient(145deg, #ff8c00, #ffa500); border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: all 0.2s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.5); filter: brightness(1.1); }
        button:active { transform: translateY(1px); box-shadow: 0 2px 3px rgba(0,0,0,0.4); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* --- ç‰¹æ•ˆæ¨£å¼ --- */
        .damage-indicator {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ff4d4d;
            text-shadow: 1px 1px 2px #000;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes floatUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-60px); }
        }

        .exp-indicator {
            position: absolute;
            font-size: 22px;
            font-weight: bold;
            color: #FFD700; /* Gold */
            text-shadow: 1px 1px 2px #000;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }

        .slash-effect {
            position: absolute;
            width: 100px;
            height: 120px;
            pointer-events: none;
            z-index: 10;
            animation: slash-anim 0.3s ease-out forwards;
        }
        .slash-effect::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 45%, white 48%, white 52%, transparent 55%);
            transform: rotate(10deg);
        }
        @keyframes slash-anim {
            0% { transform: scale(0) rotate(0); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1.2) rotate(20deg); opacity: 0; }
        }
        
        .impact-effect {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 215, 0, 0.8) 30%, rgba(255, 165, 0, 0) 65%);
            animation: impact-anim 0.35s ease-out forwards;
        }
        @keyframes impact-anim {
             0% { transform: scale(0.5); opacity: 1; }
             80% { transform: scale(1.6); opacity: 0.5; }
             100% { transform: scale(1.9); opacity: 0; }
        }

    </style>
</head>
<body>
    <div id="app-wrapper">
        <!-- ä¿®ç…‰é¢æ¿ -->
        <div id="cultivation-panel">
            <h2>ä¿®ç…‰</h2>
            <div id="weather-info">
                <p><span id="weather-location">è®€å–å¤©æ°£ä¸­...</span></p>
                <p><span id="weather-condition">--</span> | æº«åº¦: <span id="weather-temp">--</span>Â°C | æ¿•åº¦: <span id="weather-humidity">--</span>%</p>
            </div>
            <div class="meditation-visual">
                <div class="meditation-container">
                    <img src="./player_image.png" alt="ä¿®ç…‰ä¸­çš„å°äºº" class="meditating-person-img" onerror="this.style.display='none'">
                    <div class="revolving-orb"></div>
                </div>
            </div>
            <div class="cultivation-stats">
                <p>ç¶“é©—å€¼: <span id="player-exp">0</span></p>
                <p>ä¿®ç…‰é€Ÿåº¦: <span id="exp-rate">1.00</span> é»/ç§’</p>
            </div>
        </div>

        <div id="game-container">
            <!-- æˆ°é¬¥ç•«é¢ -->
            <div id="combat-screen">
                <!-- æ€ªç‰©é¡¯ç¤ºå€ -->
                <div id="monster" class="character-card">
                    <h2 id="monster-name"></h2>
                    <p>ç”Ÿå‘½:</p>
                    <div class="bar-container"><div id="monster-health-bar" class="bar"></div></div>
                    <p class="hp-text" id="monster-hp-text"></p>
                    <p>è¡Œå‹•æ¢:</p>
                    <div class="bar-container"><div id="monster-action-bar" class="bar"></div></div>
                    <p>æ”»æ“Š: <span id="monster-atk"></span> | é˜²ç¦¦: <span id="monster-def"></span> | é€Ÿåº¦: <span id="monster-spd"></span></p>
                </div>

                <!-- ç©å®¶é¡¯ç¤ºå€ -->
                <div id="player" class="character-card">
                    <h2>ç©å®¶</h2>
                    <p>ç”Ÿå‘½:</p>
                    <div class="bar-container"><div id="player-health-bar" class="bar"></div></div>
                    <p class="hp-text" id="player-hp-text"></p>
                    <p>è¡Œå‹•æ¢:</p>
                    <div class="bar-container"><div id="player-action-bar" class="bar"></div></div>
                    <p>æ”»æ“Š: <span id="player-atk"></span> | é˜²ç¦¦: <span id="player-def"></span> | é€Ÿåº¦: <span id="player-spd"></span></p>
                </div>
            </div>

            <!-- æˆ°é¬¥æ—¥èªŒ -->
            <div id="combat-log"></div>

            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div id="controls">
                <button id="start-pause-button">é–‹å§‹æˆ°é¬¥</button>
                <button id="restart-button" style="display: none;">é‡æ–°é–‹å§‹</button>
            </div>
        </div>

        <!-- æ¸¬è©¦ç”¨æ§åˆ¶é … -->
        <div id="test-controls">
            <label for="monster-select">é¸æ“‡æ¸¬è©¦æ€ªç‰©:</label>
            <select id="monster-select"></select>
        </div>
    </div>


    <!-- å‹™å¿…åœ¨ä¸»è…³æœ¬ä¹‹å‰è¼‰å…¥æ€ªç‰©è³‡æ–™åº« -->
    <script src="monsters.js"></script>

    <script>
        // --- 1. åˆå§‹è§’è‰²æ•¸å€¼ ---
        const initialPlayerStats = { name: "ç©å®¶", maxHp: 100, hp: 100, atk: 20, def: 5, spd: 20 };
        
        let playerStats = { ...initialPlayerStats, actionProgress: 0 };
        let monsterStats = {}; // åˆå§‹åŒ–ç‚ºç©ºç‰©ä»¶ï¼Œå°‡ç”± resetGame å¡«å…¥

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let playerExperience = 0;
        let currentTemperature = null;
        let currentHumidity = null;
        let monsterLevel = 1;
        let isGameRunning = false;
        let gameInterval = null;
        const ACTION_THRESHOLD = 1000;
        const TICK_RATE = 50;

        // --- 2. ç²å– HTML å…ƒç´  ---
        const weatherLocationEl = document.getElementById('weather-location');
        const weatherConditionEl = document.getElementById('weather-condition');
        const weatherTempEl = document.getElementById('weather-temp');
        const weatherHumidityEl = document.getElementById('weather-humidity');
        const playerExpEl = document.getElementById('player-exp');
        const expRateEl = document.getElementById('exp-rate');
        const playerHpTextEl = document.getElementById('player-hp-text');
        const playerAtkEl = document.getElementById('player-atk');
        const playerDefEl = document.getElementById('player-def');
        const playerSpdEl = document.getElementById('player-spd');
        const playerHealthBarEl = document.getElementById('player-health-bar');
        const playerActionBarEl = document.getElementById('player-action-bar');
        const monsterNameEl = document.getElementById('monster-name');
        const monsterHpTextEl = document.getElementById('monster-hp-text');
        const monsterAtkEl = document.getElementById('monster-atk');
        const monsterDefEl = document.getElementById('monster-def');
        const monsterSpdEl = document.getElementById('monster-spd');
        const monsterHealthBarEl = document.getElementById('monster-health-bar');
        const monsterActionBarEl = document.getElementById('monster-action-bar');
        const startPauseButton = document.getElementById('start-pause-button');
        const restartButton = document.getElementById('restart-button');
        const combatLog = document.getElementById('combat-log');
        const playerCard = document.getElementById('player');
        const monsterCard = document.getElementById('monster');
        const combatScreenEl = document.getElementById('combat-screen');
        const meditationContainerEl = document.querySelector('.meditation-container');
        const monsterSelectEl = document.getElementById('monster-select');

        // --- 3. éŠæˆ²æ ¸å¿ƒåŠŸèƒ½ ---

        function translateWeatherCode(code) {
            const weatherMap = {
                0: "æ™´å¤© â˜€ï¸", 1: "æ™´æ™‚å¤šé›² ğŸŒ¤ï¸", 2: "å¤šé›² ğŸŒ¥ï¸", 3: "é™°å¤© â˜ï¸",
                45: "éœ§ ğŸŒ«ï¸", 48: "éœ§ ğŸŒ«ï¸", 51: "æ¯›æ¯›é›¨ ğŸ’§", 53: "æ¯›æ¯›é›¨ ğŸ’§",
                55: "æ¯›æ¯›é›¨ ğŸ’§", 61: "é›¨å¤© ğŸŒ§ï¸", 63: "å¤§é›¨ ğŸŒ§ï¸", 65: "è±ªé›¨ ğŸŒ§ï¸",
                80: "é™£é›¨ ğŸŒ¦ï¸", 81: "é™£é›¨ ğŸŒ¦ï¸", 82: "å¼·é™£é›¨ ğŸŒ¦ï¸", 95: "é›·é›¨ â›ˆï¸",
                96: "é›·é›¨ â›ˆï¸", 99: "é›·é›¨ â›ˆï¸",
            };
            return weatherMap[code] || "æœªçŸ¥å¤©æ°£";
        }

        function calculateExperienceGain() {
            if (currentTemperature === null || currentHumidity === null) {
                return 1.0; // å¦‚æœå¤©æ°£è³‡æ–™é‚„æ²’ä¾†ï¼Œå…ˆçµ¦é è¨­å€¼
            }

            // ä¸­åº¸ä¹‹é“è¦å‰‡è¨­å®š
            const OPTIMAL_TEMP_MIN = 20, OPTIMAL_TEMP_MAX = 25;
            const BAD_TEMP_LOW = 10, BAD_TEMP_HIGH = 35;
            const OPTIMAL_HUMID_MIN = 40, OPTIMAL_HUMID_MAX = 60;
            const BAD_HUMID_LOW = 20, BAD_HUMID_HIGH = 80;

            // æ­¤å‡½å¼è¨ˆç®—å–®ä¸€è®Šæ•¸çš„åˆ†æ•¸ (0.0 to 1.0)
            function calculateBonus(value, min, max, badLow, badHigh) {
                if (value >= min && value <= max) return 1.0; // æœ€ä½³å€é–“
                if (value < min && value > badLow) return (value - badLow) / (min - badLow); // å¾å·®åˆ°æœ€ä½³çš„çˆ¬å‡å€é–“
                if (value > max && value < badHigh) return 1.0 - ((value - max) / (badHigh - max)); // å¾æœ€ä½³åˆ°å·®çš„ä¸‹é™å€é–“
                return 0.0; // æœ€å·®å€é–“
            }

            const tempBonus = calculateBonus(currentTemperature, OPTIMAL_TEMP_MIN, OPTIMAL_TEMP_MAX, BAD_TEMP_LOW, BAD_TEMP_HIGH);
            const humidBonus = calculateBonus(currentHumidity, OPTIMAL_HUMID_MIN, OPTIMAL_HUMID_MAX, BAD_HUMID_LOW, BAD_HUMID_HIGH);
            
            // åŸºç¤ç‚º 1, æº«åº¦å’Œæ¿•åº¦å„è²¢ç» 0~1 çš„åŠ æˆ, ç¸½è¨ˆç¯„åœ 1~3
            const totalExpGain = 1 + tempBonus + humidBonus;
            
            return totalExpGain;
        }


        async function fetchWeather() {
            // åº§æ¨™è¨­å®šç‚º å°åŒ—å¸‚ ä¿¡ç¾©å€
            const lat = 25.03;
            const lon = 121.56;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('å¤©æ°£APIå›æ‡‰éŒ¯èª¤');
                }
                const data = await response.json();
                
                // æ›´æ–°å¤©æ°£å…¨åŸŸè®Šæ•¸
                currentTemperature = data.current.temperature_2m;
                currentHumidity = data.current.relative_humidity_2m;
                const weatherCode = data.current.weather_code;

                // æ›´æ–°UIé¡¯ç¤º
                weatherLocationEl.textContent = 'å°åŒ—å¸‚, ä¿¡ç¾©å€';
                weatherConditionEl.textContent = translateWeatherCode(weatherCode);
                weatherTempEl.textContent = currentTemperature;
                weatherHumidityEl.textContent = currentHumidity;
                
                // æ›´æ–°ä¿®ç…‰é€Ÿåº¦é¡¯ç¤º
                const currentExpRate = calculateExperienceGain();
                expRateEl.textContent = currentExpRate.toFixed(2);


            } catch (error) {
                console.error("ç„¡æ³•ç²å–å¤©æ°£è³‡è¨Š:", error);
                weatherLocationEl.textContent = "ç„¡æ³•è¼‰å…¥å¤©æ°£";
            }
        }

        function updateUI() {
            // æ›´æ–°æˆ°é¬¥UI
            playerAtkEl.textContent = playerStats.atk;
            playerDefEl.textContent = playerStats.def;
            playerSpdEl.textContent = playerStats.spd;
            playerHpTextEl.textContent = `${playerStats.hp} / ${playerStats.maxHp}`;
            playerHealthBarEl.style.width = `${(playerStats.hp / playerStats.maxHp) * 100}%`;
            playerActionBarEl.style.width = `${(playerStats.actionProgress / ACTION_THRESHOLD) * 100}%`;
            
            if (monsterStats.name) {
                monsterNameEl.textContent = `${monsterStats.name} Lv.${monsterLevel}`;
                monsterAtkEl.textContent = monsterStats.atk;
                monsterDefEl.textContent = monsterStats.def;
                monsterSpdEl.textContent = monsterStats.spd;
                monsterHpTextEl.textContent = `${monsterStats.hp} / ${monsterStats.maxHp}`;
                monsterHealthBarEl.style.width = `${(monsterStats.hp / monsterStats.maxHp) * 100}%`;
                monsterActionBarEl.style.width = `${(monsterStats.actionProgress / ACTION_THRESHOLD) * 100}%`;
            }
        }

        function updateCultivationUI() {
            // æ›´æ–°ä¿®ç…‰UIï¼Œç¸½ç¶“é©—å€¼é¡¯ç¤ºç‚ºå››æ¨äº”å…¥å¾Œçš„æ•´æ•¸
            playerExpEl.textContent = Math.round(playerExperience);
        }

        function gainExperience() {
            const expAmount = calculateExperienceGain();
            playerExperience += expAmount;
            showExperienceGainIndicator(expAmount.toFixed(2));
            updateCultivationUI();
        }

        function showExperienceGainIndicator(amount) {
            const indicator = document.createElement('div');
            indicator.textContent = `+${amount}`;
            indicator.className = 'exp-indicator';
            meditationContainerEl.appendChild(indicator);
            
            const xOffset = (Math.random() - 0.5) * 40;
            indicator.style.left = `calc(50% + ${xOffset}px)`;
            indicator.style.top = '20%';
            indicator.style.transform = 'translateX(-50%)';
            
            setTimeout(() => indicator.remove(), 900);
        }

        function logMessage(message, color = '#e0e0e0') {
            if (combatLog.children.length > 100) { combatLog.removeChild(combatLog.lastChild); }
            const p = document.createElement('p');
            p.textContent = message;
            p.style.color = color;
            combatLog.prepend(p);
        }

        function showDamageIndicator(targetCard, damage) {
            const indicator = document.createElement('div');
            indicator.textContent = `-${damage}`;
            indicator.className = 'damage-indicator';
            combatScreenEl.appendChild(indicator);
            const xOffset = (Math.random() - 0.5) * 40;
            indicator.style.left = `${targetCard.offsetLeft + targetCard.offsetWidth / 2 - indicator.offsetWidth / 2 + xOffset}px`;
            indicator.style.top = `${targetCard.offsetTop}px`;
            setTimeout(() => indicator.remove(), 900);
        }

        function playAttackAnimation(targetCard, type) {
            const effect = document.createElement('div');
            effect.className = type === 'slash' ? 'slash-effect' : 'impact-effect';
            combatScreenEl.appendChild(effect);
            effect.style.left = `${targetCard.offsetLeft + targetCard.offsetWidth / 2 - effect.offsetWidth / 2}px`;
            effect.style.top = `${targetCard.offsetTop + targetCard.offsetHeight / 2 - effect.offsetHeight / 2}px`;
            setTimeout(() => effect.remove(), 350);
        }

        function spawnNextMonster() {
            monsterLevel++;
            logMessage(`é­é‡æ–°çš„æ•µäººï¼`, '#FFD700');
            playerStats.hp = playerStats.maxHp;
            const monsterIndex = (monsterLevel - 1) % MONSTERS_DATABASE.length;
            const monsterData = MONSTERS_DATABASE[monsterIndex];
            monsterStats = { ...monsterData, hp: monsterData.maxHp, actionProgress: 0, };
            monsterSelectEl.value = monsterIndex;
        }
        
        function gameLoop() {
            if (!isGameRunning) return;
            const fasterSpd = Math.max(playerStats.spd, monsterStats.spd);
            if (fasterSpd <= 0) return;
            const desiredAttackTimeMs = 1000;
            const ticksToAttackForFaster = desiredAttackTimeMs / TICK_RATE; 
            const baseProgressGain = ACTION_THRESHOLD / ticksToAttackForFaster; 
            const playerProgressGain = baseProgressGain * (playerStats.spd / fasterSpd);
            const monsterProgressGain = baseProgressGain * (monsterStats.spd / fasterSpd);
            playerStats.actionProgress += playerProgressGain;
            monsterStats.actionProgress += monsterProgressGain;

            if (playerStats.actionProgress >= ACTION_THRESHOLD) {
                playerStats.actionProgress -= ACTION_THRESHOLD;
                let damage = Math.max(0, playerStats.atk - monsterStats.def);
                monsterStats.hp = Math.max(0, monsterStats.hp - damage);
                logMessage(`ä½ å° ${monsterStats.name} é€ æˆäº† ${damage} é»å‚·å®³ã€‚`, '#87CEFA');
                showDamageIndicator(monsterCard, damage);
                playAttackAnimation(monsterCard, 'slash');
                monsterCard.classList.add('attacking');
                combatScreenEl.classList.add('screen-shake');
                setTimeout(() => {
                    monsterCard.classList.remove('attacking');
                    combatScreenEl.classList.remove('screen-shake');
                }, 300);
                if (monsterStats.hp <= 0) {
                    logMessage(`ä½ æ“Šæ•—äº† ${monsterStats.name}ï¼`, '#90EE90');
                    spawnNextMonster();
                }
            }

            if (monsterStats.actionProgress >= ACTION_THRESHOLD) {
                 if (monsterStats.hp > 0) {
                    monsterStats.actionProgress -= ACTION_THRESHOLD;
                    let damage = Math.max(0, monsterStats.atk - playerStats.def);
                    playerStats.hp = Math.max(0, playerStats.hp - damage);
                    logMessage(`${monsterStats.name} å°ä½ é€ æˆäº† ${damage} é»å‚·å®³ã€‚`, '#F08080');
                    showDamageIndicator(playerCard, damage);
                    playAttackAnimation(playerCard, 'impact');
                    playerCard.classList.add('attacking');
                    combatScreenEl.classList.add('screen-shake');
                    setTimeout(() => {
                        playerCard.classList.remove('attacking');
                        combatScreenEl.classList.remove('screen-shake');
                    }, 300);
                    if (playerStats.hp <= 0) {
                        logMessage('ä½ è¢«æ“Šæ•—äº†... éŠæˆ²çµæŸã€‚', '#DC143C');
                        isGameRunning = false;
                        clearInterval(gameInterval);
                        gameInterval = null;
                        startPauseButton.style.display = 'none';
                        restartButton.style.display = 'block';
                    }
                } else {
                    monsterStats.actionProgress = 0;
                }
            }
            updateUI();
        }

        function toggleCombat() {
            isGameRunning = !isGameRunning;
            if (isGameRunning) {
                startPauseButton.textContent = 'æš«åœæˆ°é¬¥';
                if (!gameInterval) { gameInterval = setInterval(gameLoop, TICK_RATE); }
            } else {
                startPauseButton.textContent = 'ç¹¼çºŒæˆ°é¬¥';
            }
        }
        
        function resetGame() {
            startSpecificMonsterFight(0);
        }
        
        function startSpecificMonsterFight(monsterIndex) {
            isGameRunning = false;
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;

            monsterLevel = monsterIndex + 1;
            playerStats = { ...initialPlayerStats, actionProgress: 0 };

            const selectedMonsterData = MONSTERS_DATABASE[monsterIndex];
            monsterStats = {
                ...selectedMonsterData,
                hp: selectedMonsterData.maxHp,
                actionProgress: 0,
            };

            combatLog.innerHTML = "";
            logMessage(`æ¸¬è©¦æˆ°é¬¥é–‹å§‹ï¼å°æ‰‹: ${monsterStats.name}`);

            startPauseButton.textContent = 'é–‹å§‹æˆ°é¬¥';
            startPauseButton.style.display = 'block';
            restartButton.style.display = 'none';
            monsterSelectEl.value = monsterIndex;
            
            updateUI();
        }

        // --- 4. è¨­å®šäº‹ä»¶ç›£è½ ---
        startPauseButton.addEventListener('click', toggleCombat);
        restartButton.addEventListener('click', resetGame);
        monsterSelectEl.addEventListener('change', (event) => {
            const selectedIndex = parseInt(event.target.value, 10);
            startSpecificMonsterFight(selectedIndex);
        });

        // --- 5. éŠæˆ²åˆå§‹åŒ– ---
        function populateMonsterSelector() {
            MONSTERS_DATABASE.forEach((monster, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = monster.name;
                monsterSelectEl.appendChild(option);
            });
        }

        function initGame() {
            populateMonsterSelector();
            logMessage("é»æ“ŠæŒ‰éˆ•é–‹å§‹è‡ªå‹•æˆ°é¬¥ã€‚");
            setInterval(gainExperience, 1000); // é–‹å§‹è‡ªå‹•ç²å–ç¶“é©—
            fetchWeather(); // éŠæˆ²è¼‰å…¥æ™‚ç²å–å¤©æ°£
            setInterval(fetchWeather, 900000); // æ¯ 15 åˆ†é˜æ›´æ–°ä¸€æ¬¡å¤©æ°£
            resetGame(); 
        }

        initGame();
    </script>
</body>
</html>

